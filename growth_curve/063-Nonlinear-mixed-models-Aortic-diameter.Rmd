---
title: '6.3 Nonlinear Mixed Models for the Variable aortic diameter (''Diam_aorta'')'
author: 
  - name: "Júlia Cano Raluy"
    affiliation: "Mathematics student at Autonomous University of Barcelona (UAB)"
  - name: "Juan R González"
    affiliation: 
      - "Bioinformatics Research Group in Epidemiology (BRGE), Barcelona Institute for Global Health (ISGlobal)"
      - "Department of Mathematics, Autonomous University of Barcelona (UAB)"
    email: juanr.gonzalez@isglobal.org
date: "`r Sys.Date()`"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment="", warning=FALSE, message=FALSE, cache=TRUE, fig.pos = "H", out.extra = "")

packages <- c("tidyverse", "caret", "reshape2", "ggplot2", "recipes", "factoextra", "lubridate", "lattice", "lme4", "MASS", "nlme", "tibble", "growthmodels")

install_and_load <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

invisible(lapply(packages, install_and_load))

load("densitometriapre5.Rdata")
load("ecocardiogramapre5.Rdata")
```


##  Contents

1. [Logistic Model](#logistic-model)
   1. [Initial Values](#initial-values)
   2. [Fitting the Logistic Model](#fitting-the-logistic-model)
2. [Gompertz Models](#gompertz-models)
   1. [Initial Values](#initial-values)
   2. [Fitting the Gompertz Model](#fitting-the-gompertz-model)
3. [Linear Models](#linear-models)
4. [Model Diagnostics](#model-diagnostics)
5. [Final Comparison of Metrics Logistic and Gompertz Models](#final-comparison-of-metrics-logistic-and-gompertz-models)
6. [Graphs and Visualization of Results](#graphs-and-visualization-of-results)

```{r}
df0 <- dfpreeco
y <- "Diam_aorta"

df <- df0 %>%
  group_by(Id) %>%
  dplyr::summarise(n = n()) %>%
  filter(n > 3) %>%
  inner_join(dfpreeco, by = "Id") %>%
  dplyr::select(-n)%>% 
  dplyr::mutate(Seccio= as.factor(Seccio)) %>% 
  filter(Edat < 40)

df$Seccio <- relevel(df$Seccio, ref = "SALA")

```

# Logistic Model

## Initial Values

```{r}
beta0 <- max(df0[[y]]) + 0.1 * max(df0[[y]])
lmbeta <- lm(logit(df0[[y]] / beta0) ~ Edat, df0)
start_values_beta <-c(beta0= beta0 , 
                        beta1=lmbeta$coefficients[[1]],
                        beta2=lmbeta$coefficients[[2]])
ModellogFunc <- function(x, b1, b2, b3) { b1 / (1 + exp(-(b2 + b3 * x))) }
  
mod.log <- nls(df0[[y]] ~ ModellogFunc(Edat, beta0, beta1, beta2),
               start = start_values_beta,
               data = df0, trace = FALSE,
              control = nls.control(maxiter = 100))
start_values <- c(Asym = coef(mod.log)[[1]], 
                        xmid = -coef(mod.log)[[2]] / coef(mod.log)[[3]], 
                        scal = 1/coef(mod.log)[[3]])
start_values
```

## Fitting the Logistic Model

```{r}
ModelFunc <- function(x, Asym, xmid, scal) {
  Asym / (1 + exp((xmid - x) / scal))
}

formula <- as.formula(paste(y, "~ ModelFunc(Edat, Asym, xmid, scal)"))
```

```{r}
dfG <- groupedData(as.formula(paste(y, "~ Edat | Id")), data = df)

fitL <- nlsList(as.formula(paste(y, "~ SSlogis(Edat, Asym, xmid, scal)")), data = dfG, start = start_values, control = nlmeControl(maxIter = 100000, msMaxIter = 100))
nlme.randomasym<- nlme(fitL, random = Asym ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100))

nlme.randomCAR1asym<- nlme(fitL, random = Asym ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                     correlation=corCAR1(form = ~ 1 | Id))
nlme.randomCAR1scal<- nlme(fitL, random = scal ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                     correlation=corCAR1(form = ~ 1 | Id))

fx0 <- fixef(nlme.randomasym)
fx1 <- fixef(nlme.randomCAR1asym)
fx2 <- fixef(nlme.randomCAR1scal)
```


```{r}
model0 <- paste("modbase", y, sep = ".")
mod0 <- nls(as.formula(paste(y, "~ SSlogis(Edat, Asym, xmid, scal)")), 
                 data = df,
                 start = start_values,
                 control = nlmeControl(maxIter = 100000, msMaxIter = 100))
assign(model0, mod0)
print(get(model0))

##############################

model1 <- paste("mod1", y, "seccio", sep = ".")
mod1<- update(nlme.randomasym, fixed = list(Asym ~ Seccio, xmid + scal ~ 1),
                           start = as.numeric(c(fx0["Asym"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx0["xmid"],
                                  fx0["scal"])))
assign(model1, mod1)
print(get(model1))
###############################

model2 <- paste("mod2", y, "seccio", sep = ".")
mod2 <- update(nlme.randomCAR1asym, fixed = list(Asym ~ Seccio, xmid + scal ~ 1),
                           start = as.numeric(c(fx1["Asym"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx1["xmid"],
                                  fx1["scal"])))
assign(model2, mod2)
print(get(model2))
###############################

model3 <- paste("mod3", y, "seccio", sep = ".")
mod3 <- update(nlme.randomCAR1scal, fixed = list(Asym ~ Seccio, xmid + scal ~ 1),
                           start = as.numeric(c(fx2["Asym"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx2["xmid"],
                                  fx2["scal"])))
assign(model3, mod3)
print(get(model3))

```


# Gompertz Models

## Initial Values

```{r, fig.width=6, fig.height=6 }

library(growthmodels)

beta0 <- max(df[[y]]) + 0.1 * max(df[[y]])
lmbeta <- lm(log(log(beta0/df[[y]])) ~ Edat, data = df)

start_values_beta <- list(beta0 = beta0,
                          beta1 = exp(lmbeta$coefficients[[1]]),
                          beta2 = -lmbeta$coefficients[[2]])

mod.log<- nls(as.formula(paste(y, " ~ growthmodels::gompertz(Edat, beta0, beta1, beta2)")),
            start = start_values_beta,
            data= df, trace=FALSE, control = nls.control(maxiter = 100))

start_values_beta <-c(beta0=  coef(mod.log)[[1]] , 
                        beta1= coef(mod.log)[[2]],
                        beta2= coef(mod.log)[[3]])


start_values_beta
```

## Fitting the Gompertz Models

```{r}
fitL <- nlsList(as.formula(paste(y, " ~ growthmodels::gompertz(Edat, beta0, beta1, beta2)")), 
                data = dfG, start = start_values_beta,
                control = nlmeControl(maxIter = 100000, msMaxIter = 100))

nlme.randomb0g<- nlme(fitL, random = beta0 ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                     method = "ML")

nlme.randomCAR1b0g<- nlme(fitL, random = beta0 ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                    correlation=corCAR1(form = ~ 1 | Id),
                     method = "ML")

nlme.randomCAR1b1g<- nlme(fitL, random = beta1 ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                    correlation=corCAR1(form = ~ 1 | Id),
                     method = "ML")

nlme.randomCAR1b2g<- nlme(fitL, random = beta2 ~ 1, 
                     control = nlmeControl(maxIter = 100000, msMaxIter = 100),
                     correlation=corCAR1(form = ~ 1 | Id),
                     method = "ML")


fx1 <- fixef(nlme.randomb0g)
fx2 <- fixef(nlme.randomCAR1b0g)
fx3 <- fixef(nlme.randomCAR1b1g)
fx4 <- fixef(nlme.randomCAR1b2g)
```

```{r}

model0g <- paste("mod0", y, "g", sep = ".")
mod0.g <- nls(as.formula(paste(y, " ~ growthmodels::gompertz(Edat, beta0, beta1, beta2)")), 
                 data = df,
                 start = start_values_beta,
                 control = nlmeControl(maxIter = 100000, msMaxIter = 100))
assign(model0g, mod0.g)

#####################################
model1g <- paste("mod1", y, "seccio","g", sep = ".")
mod1g <- update(nlme.randomb0g, fixed = list(beta0 ~ Seccio, beta1 + beta2 ~ 1),
                           start = as.numeric(c(fx1["beta0"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx1["beta1"],
                                  fx1["beta2"])))

assign(model1g, mod1g)

#####################################
model2g <- paste("mod2", y, "seccio","g", sep = ".")
mod2g <- update(nlme.randomCAR1b0g, fixed = list(beta0 ~ Seccio, beta1 + beta2 ~ 1),
                           start = as.numeric(c(fx2["beta0"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx2["beta1"],
                                  fx2["beta2"])))
assign(model2g, mod2g)

#####################################
model3g <- paste("mod3", y, "seccio","g", sep = ".")
mod3g <- update(nlme.randomCAR1b2g, fixed = list(beta0 ~ Seccio, beta1 + beta2 ~ 1),
                           start = as.numeric(c(fx4["beta0"], 
                                  rep(0, length(unique(df$Seccio))-1),
                                  fx4["beta1"],
                                  fx4["beta2"])))

assign(model3g, mod3g)

```

# Linear Models

```{r}
mod.lin <- lm(Diam_aorta~Edat, data= df)

plot_model(mod.lin, "pred",  
          ci.lvl = 0.95, 
          show.data = TRUE, 
          terms = "Edat",  
          title = "Model lineal",
          jitter= TRUE
          )
mod.lin
#transformaicó logaritmica
mod.lin.log <- lm(Diam_aorta~log(Edat), data= df)
plot_model(mod.lin.log, "pred",  
          ci.lvl = 0.95, 
          show.data = TRUE, 
          terms = "Edat",  
          title = "Model log",
          jitter= TRUE
          )
mod.lin.log
```

# Model Diagnostics

```{r}
qqnorm(residuals(get(model0)))
qqline(residuals(get(model0)), col = "red")
qqnorm(residuals(get(model1)))
qqline(residuals(get(model1)), col = "red")
qqnorm(residuals(get(model2)))
qqline(residuals(get(model2)), col = "red")
qqnorm(residuals(get(model3)))
qqline(residuals(get(model3)), col = "red")
plot(get(model0))
plot(get(model1))
plot(get(model2))
plot(get(model3))
```

```{r}
qqnorm(residuals(get(model0g)))
qqline(residuals(get(model0g)), col = "red")
qqnorm(residuals(get(model1g)))
qqline(residuals(get(model1g)), col = "red")
qqnorm(residuals(get(model2g)))
qqline(residuals(get(model2g)), col = "red")
qqnorm(residuals(get(model3g)))
qqline(residuals(get(model3g)), col = "red")
plot(get(model0g))
plot(get(model1g))
plot(get(model2g))
plot(get(model3g))
```

# Final Comparison of Metrics Logistic and Gompertz Models

```{r}
mod.list.combined <- list(
  lineal = mod.lin,
  mod0 = get(model0),
  mod1 = get(model1),
  mod2 = get(model2),
  mod0g = get(model0g), 
  mod1g = get(model1g),
  mod2g = get(model2g),
  mod3g = get(model3g)
)
get_metrics <- function(model) {
  metrics <- data.frame(
    `-2LogV` = -2*logLik(model),
    AIC = AIC(model), 
    BIC = BIC(model)
  )
  return(metrics)
}
comparacio <- imap_dfr(mod.list.combined , ~ {
  metrics <- get_metrics(.x)
  data.frame(Model = .y, metrics)
})

comparacio <- comparacio %>% dplyr::rename(`-2LogV`= `X.2LogV`) %>%  arrange(AIC)
comparacio

comparacio%>%
gather(x, y, `-2LogV`:BIC) %>%
ggplot(aes(x = x, y = y, color = Model)) +
geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
labs(title = "Comparació de mètriques",
     x = "Mètriques",
     y = "Valor")
```

# Graphs and Visualization of Results

```{r, fig.width=7, fig.height=4, warning=FALSE}
logist <- function(Edat, Asym, xmid, scal) {
  Asym / (1 + exp((xmid - Edat) / scal))
}

coef <- fixef(get(model2))
newdat <- expand.grid(Seccio = unique(df$Seccio[df$Seccio != "SALA"]), 
                       Edat = seq(min(df$Edat), max(df$Edat), length.out = 100))
newdat <- within(newdat, {
  Predicted<- logist(Edat, 
                          Asym = coef["Asym.(Intercept)"] + coef[paste0("Asym.Seccio", Seccio)],
                          xmid = coef["xmid"],
                          scal = coef["scal"])})

newdat <- rbind(newdat, data.frame(Seccio = "SALA", 
                                   Edat = seq(min(df$Edat), max(df$Edat), length.out = 100),
                                   Predicted = logist(seq(min(df$Edat), max(df$Edat), length.out = 100),
                                                           Asym = coef["Asym.(Intercept)"],
                                                           xmid = coef["xmid"],
                                                           scal = coef["scal"])))


p <- ggplot(df, aes(x = Edat, y = get(y), colour = Seccio)) +
  geom_point(size = 0.75, alpha = 0.6) +  
  geom_line(aes(y = predict(get(model2)), group = Id), alpha = 0.3) + 
  labs(y = y)+
  scale_size_manual(name = "Prediccions", values = c("Id" = 0.2)) +
  theme_bw(base_size = 22)

g <- p + 
  geom_line(data = newdat, aes(x = Edat, y = Predicted, group = Seccio), size = 1.2, alpha = 0.6) + 
  scale_size_manual(name = "Prediccions", values = c("Id" = 0.5, "Població" = 3))

print(g)


summary(get(model2))
anova(get(model2))
plot(get(model2))
get(model2)
```

